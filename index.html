<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Colección de Monedas</title>
  <link rel="icon" type="image/png" href="icon.png">
  <style>
    body { font-family: sans-serif; margin: 0; padding: 0; background: #f9f9f9; }
    header { background-color: #333; color: #fff; padding: 1rem; text-align: center; }
    .category { margin: 1rem; padding: 1rem; background: #fff; border-radius: 8px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
    .category h2 { margin-top: 0; }
    .photos { display: flex; flex-wrap: wrap; gap: 1rem; align-items: flex-start; }
    .photo { perspective: 1000px; width: 150px; display: flex; flex-direction: column; align-items: center; }
    .photo-inner { position: relative; width: 100%; transform-style: preserve-3d; transition: transform 0.8s; }
    .photo:hover .photo-inner { transform: rotateY(180deg); }
    .photo-front, .photo-back {
      position: absolute; width: 100%; backface-visibility: hidden; border-radius: 6px; overflow: hidden;
      text-align: center; display: flex; flex-direction: column;
      background: transparent;
    }
    .photo-front img, .photo-back img { width: 100%; border-radius: 4px; }
    .photo-back { transform: rotateY(180deg); }
    .photo small { display: block; margin-top: 0.3rem; font-size: 0.9em; text-align: center; }
    .admin-panel { position: fixed; bottom: 10px; right: 10px; background: rgba(255,255,255,0.9); padding: 0.5rem; border: 1px solid #ccc; border-radius: 6px; }
    .admin-only { display: none; margin-top: 1rem; }
    .timeline { font-size: 0.9em; color: #666; }
  </style>
</head>
<body>
  <header><h1>Colección de Monedas</h1></header>
  <div id="gallery"></div>

  <div class="admin-panel">
    <input type="password" id="passwordInput" placeholder="Contraseña">
    <button onclick="login()">Entrar</button>
    <div class="admin-only">
      <h3>Añadir Categoría</h3>
      <input type="text" id="newCategory" placeholder="Nombre categoría">
      <button onclick="addCategory()">Añadir</button>

      <h3>Añadir Foto</h3>
      <select id="categorySelect"></select><br>
      <input type="file" id="fileInputFront" accept="image/*"><br>
      <input type="file" id="fileInputBack" accept="image/*"><br>
      <input type="text" id="urlInputFront" placeholder="URL de la imagen frontal"><br>
      <input type="text" id="urlInputBack" placeholder="URL de la imagen trasera (opcional)"><br>
      <input type="text" id="photoName" placeholder="Nombre de la foto"><br>
      <input type="number" id="photoYear" placeholder="Año"><br>
      <button onclick="addPhoto()">Subir Foto</button>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
  <script>
    // ---- IndexedDB Storage System ----
    const DB_NAME = "photoGalleryDB";
    const DB_VERSION = 1;
    const STORE_NAME = "gallery";
    let db;
    let isAdmin = false;
    const passwordHash = "68110fb818401ca4d194e7c7b1a2d9b1";

    // Utility functions for IndexedDB
    function openDB(callback) {
      const request = indexedDB.open(DB_NAME, DB_VERSION);
      request.onupgradeneeded = function(event) {
        db = event.target.result;
        if (!db.objectStoreNames.contains(STORE_NAME)) {
          db.createObjectStore(STORE_NAME);
        }
      };
      request.onsuccess = function(event) {
        db = event.target.result;
        if (callback) callback();
      };
      request.onerror = function(event) {
        alert("Error abriendo la base de datos.");
      };
    }

    function getData(cb) {
      openDB(() => {
        const tx = db.transaction(STORE_NAME, "readonly");
        const store = tx.objectStore(STORE_NAME);
        const req = store.get("data");
        req.onsuccess = function() {
          let result = req.result;
          if (!result) result = {};
          cb(result);
        };
        req.onerror = function() { cb({}); };
      });
    }

    function setData(newData, cb) {
      openDB(() => {
        const tx = db.transaction(STORE_NAME, "readwrite");
        const store = tx.objectStore(STORE_NAME);
        const req = store.put(newData, "data");
        req.onsuccess = function() { if (cb) cb(); };
        req.onerror = function() { alert("No se pudo guardar."); };
      });
    }

    // Data object
    let data = {};

    function saveData() {
      setData(data);
    }

    function login() {
      const input = document.getElementById('passwordInput').value;
      if (md5(input) === passwordHash) {
        isAdmin = true;
        document.querySelector('.admin-only').style.display = 'block';
        render();
      } else { alert('Contraseña incorrecta'); }
    }

    function addCategory() {
      const name = document.getElementById('newCategory').value.trim();
      if (!name || data[name]) return;
      data[name] = [];
      saveData(); render();
    }

    async function addPhoto() {
      const category = document.getElementById('categorySelect').value;
      const fileFront = document.getElementById('fileInputFront').files[0];
      const fileBack = document.getElementById('fileInputBack').files[0];
      const urlFront = document.getElementById('urlInputFront').value.trim();
      const urlBack = document.getElementById('urlInputBack').value.trim();
      const name = document.getElementById('photoName').value.trim();
      const year = parseInt(document.getElementById('photoYear').value.trim());

      const process = async (frontSrc, backSrc) => {
        frontSrc = await blackToTransparent(frontSrc);
        if (backSrc) {
          backSrc = await blackToTransparent(backSrc);
        }
        data[category].push({ frontSrc, backSrc, name, year });
        data[category].sort((a, b) => (a.year || 0) - (b.year || 0));
        saveData(); render();
      };

      if (fileFront) {
        const frontSrc = await compressImage(fileFront);
        if (fileBack) {
          const backSrc = await compressImage(fileBack);
          await process(frontSrc, backSrc);
        } else if (urlBack) {
          await process(frontSrc, urlBack);
        } else {
          await process(frontSrc, null);
        }
      } else if (urlFront) {
        const frontSrc = urlFront;
        const backSrc = urlBack || null;
        await process(frontSrc, backSrc);
      } else {
        alert("Sube una imagen frontal o proporciona una URL");
      }
    }

    function render() {
      const gallery = document.getElementById('gallery');
      const selector = document.getElementById('categorySelect');
      gallery.innerHTML = ''; selector.innerHTML = '';

      for (const [category, photos] of Object.entries(data)) {
        const catDiv = document.createElement('div');
        catDiv.className = 'category';
        const title = document.createElement('h2');
        title.textContent = category;

        if (isAdmin) {
          const del = document.createElement('button');
          del.textContent = 'Eliminar categoría';
          del.onclick = () => {
            if (confirm('¿Estás seguro de eliminar esta categoría?')) {
              delete data[category]; saveData(); render();
            }
          };
          title.appendChild(del);
        }

        catDiv.appendChild(title);
        const row = document.createElement('div');
        row.className = 'photos';

        for (const photo of photos) {
          const container = document.createElement('div');
          container.className = 'photo';
          const inner = document.createElement('div');
          inner.className = 'photo-inner';

          const front = document.createElement('div');
          front.className = 'photo-front';
          const frontImg = document.createElement('img');
          frontImg.src = photo.frontSrc;
          front.appendChild(frontImg);
          inner.appendChild(front);

          const back = document.createElement('div');
          back.className = 'photo-back';
          if (photo.backSrc) {
            const backImg = document.createElement('img');
            backImg.src = photo.backSrc;
            back.appendChild(backImg);
          } else {
            const placeholder = document.createElement('div');
            placeholder.textContent = 'Sin reverso';
            placeholder.style.padding = '2em';
            back.appendChild(placeholder);
          }
          inner.appendChild(back);

          container.appendChild(inner);

          for (let i = 0; i < 8; i++) container.appendChild(document.createElement('br'));

          if (photo.name) {
            const n = document.createElement('small');
            n.textContent = photo.name;
            container.appendChild(n);
          }
          if (photo.year) {
            const t = document.createElement('small');
            t.className = 'timeline';
            t.textContent = `Año: ${photo.year}`;
            container.appendChild(t);
          }

          if (isAdmin) {
            const del = document.createElement('button');
            del.textContent = 'Eliminar';
            del.onclick = () => {
              if (confirm('¿Estás seguro de eliminar esta foto?')) {
                data[category] = data[category].filter(f => f !== photo);
                saveData(); render();
              }
            };
            container.appendChild(del);
          }

          row.appendChild(container);
        }

        catDiv.appendChild(row);
        gallery.appendChild(catDiv);
        selector.innerHTML += `<option value="${category}">${category}</option>`;
      }
    }

    function md5(str) { return CryptoJS.MD5(str).toString(); }

    async function compressImage(file) {
      return new Promise((resolve) => {
        const reader = new FileReader();
        reader.onload = (e) => {
          const img = new Image();
          img.onload = () => {
            const canvas = document.createElement('canvas');
            let w = img.width;
            let h = img.height;
            const maxW = 1881, maxH = 1843;
            if (w > maxW || h > maxH) {
              const scale = Math.min(maxW / w, maxH / h);
              w = w * scale;
              h = h * scale;
            }
            canvas.width = w; canvas.height = h;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(img, 0, 0, w, h);
            resolve(canvas.toDataURL('image/png', 0.85));
          };
          img.src = e.target.result;
        };
        reader.readAsDataURL(file);
      });
    }

    // Converts black pixels to transparent in a dataURL image
    function blackToTransparent(dataURL) {
      return new Promise((resolve) => {
        const img = new Image();
        img.crossOrigin = "anonymous";
        img.onload = function() {
          const canvas = document.createElement('canvas');
          canvas.width = img.width;
          canvas.height = img.height;
          const ctx = canvas.getContext('2d');
          ctx.drawImage(img, 0, 0);
          const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
          const d = imageData.data;
          for (let i = 0; i < d.length; i += 4) {
            // If pixel is black and fully opaque
            if (d[i] === 0 && d[i+1] === 0 && d[i+2] === 0 && d[i+3] === 255) {
              d[i+3] = 0; // Set alpha to 0 (transparent)
            }
          }
          ctx.putImageData(imageData, 0, 0);
          resolve(canvas.toDataURL("image/png"));
        };
        img.src = dataURL;
      });
    }

    window.onload = function() {
      getData(function(dbData) {
        data = dbData;
        render();
      });
    };
  </script>
</body>
</html>
